<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fórum do meu Site</title>
    <link rel="stylesheet" href="css/Dashboard.css">
    <link rel="stylesheet" href="css/publicacoes.css">
    <script type="text/javascript" src="funcoes.js"></script>

</head>

<body onload="obterPublicacoes()">
    <!--inicio do cabecalho-->
    <main class="main">
        <aside class="sidebar">
            <nav class="nav">
                <ul>
                    <li class="active"><a href="">OLÁ, <b id="b_usuario"></b></a></li>
                    <li class="active"><a href="tempo-real.html">Tempo Real</a></li>
                    <li class="active"><a href="relatorio.html">RELATÓRIOS</a></li>
                    <li class="active"><a href="grafico-chartjs.html">GRÁFICOS</a></li>
                    <li class="active"><a href="gerenciamento_funcis.html">COLABOLADORES</a></li>
                    <li class="active"><a href="Humidity_Teste.html">TABELA COMPARATIVA</a></li>
                    <li class="active logout" onclick="logoff()"><a href="">SAIR</a></li>
                </ul>
            </nav>
        </aside>
    </main>
    <!--fim do cabecalho-->



    <div class="feed">
        <div class="titulo">Relatórios</div>
        <div class="text">Selecione o periodo e o sensor de sua escolha</div>
        <div class="buttons">
            <button id="botaosensor1" class="button_2" onclick="">Semanal</button>
            <button id="botaosensor1" class="button_2" onclick="">Mensal</button>
        </div>

        <div class="buttons">
            <button id="botaosensor1" class="button" onclick="alterarCoresBotoes()">Sensor 1</button>
            <button id="botaosensor2" class="button" onclick="alterarCoresBotoes()">Sensor 2</button>
            <button id="botaosensor3" class="button" onclick="alterarCoresBotoes()">Sensor 3</button>
            <button id="botaosensor4" class="button" onclick="alterarCoresBotoes()">Sensor 4</button>
        </div>

        <div class="legenda">
            <div class="info_1">Sensor</div>
            <div class="info_2">Média</div>
            <div class="info_3">Máxima</div>
            <div class="info_4">Mínima</div>
            <div class="info_5">Data</div>
        </div>
        <div id="feed_container" class="container">
        </div>
    </div>
</body>

</html>

<script>
    function alterarCoresBotoes(idsensor) {
        console.log("executei alterarCoresBotoes")
        botaosensor1.className = "button"
        botaosensor2.className = "button"
        botaosensor3.className = "button"
        botaosensor4.className = "button"

        if (idsensor == "1000") {
            botaosensor1.className += " btn-now"
        } else if (idsensor == "1001") {
            botaosensor2.className += " btn-now"
        } else if (idsensor == "1002") {
            botaosensor3.className += " btn-now"
        } else if (idsensor == "1003") {
            botaosensor4.className += " btn-now"
        }
    }


    function publicar() {
        console.log("entrei!")
        var formulario = new URLSearchParams(new FormData(form_publicar));
        var idUsuario = sessionStorage.id_usuario_meuapp;
        fetch(`/publicacoes/publicar/${idUsuario}`, {
            method: "POST",
            body: formulario
        }).then(resposta => {

            if (resposta.ok) {
                obterPublicacoes();

                finalizarAguardar();
            } else {
                console.log('Erro ao publicar!');
                resposta.text().then(texto => {
                    console.error(texto);
                    finalizarAguardar(texto);
                });
            }
        });

        return false;
    }

    function atualizarFeed(
        leitura_resultado
        ) { // leitura_resultado é o nome dado para a resposta ao finalizar o atualizarFeed(resposta); do obter publicacoes
        console.log(leitura_resultado);
        var feed = document.getElementById("feed_container");
        feed.innerHTML = "";
        for (let i = 0; i < leitura_resultado.length; i++) {
            var publicacao = leitura_resultado[i];

            var divPublicacao = document.createElement("div")
            var divNome = document.createElement("div")
            var divDescricao = document.createElement("div")
            var divDescricao_2 = document.createElement("div")
            var divDescricao_3 = document.createElement("div")
            var divDescricao_4 = document.createElement("div")

            divNome.innerHTML = `${publicacao.fk_sensor}`; // 1° item é a lista e o 2° um elemento da lista
            divDescricao.innerHTML = publicacao.media;
            divDescricao_2.innerHTML = publicacao.maximo;
            divDescricao_3.innerHTML = publicacao.minimo;
            divDescricao_4.innerHTML = publicacao.cinco_min;

            divPublicacao.className = "publicacao"
            divNome.className = "nome";
            divDescricao.className = "descricao";
            divDescricao_2.className = "descricao";
            divDescricao_3.className = "descricao";
            divDescricao_4.className = "descricao";

            divPublicacao.appendChild(divNome);
            divPublicacao.appendChild(divDescricao);
            divPublicacao.appendChild(divDescricao_2);
            divPublicacao.appendChild(divDescricao_3);
            divPublicacao.appendChild(divDescricao_4);

            feed.appendChild(divPublicacao);
        }
    }

    function obterPublicacoes() {
        fetch("/leituras/estatisticas")
            .then(resposta => {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                        atualizarFeed(resposta);

                        finalizarAguardar();
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    finalizarAguardar("Nenhum resultado encontrado ou erro na API");
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção das publicações: ${error.message}`);
            });
    }

    function obterPublicacoesPorUsuario(idUsuario) {
        fetch(`/publicacoes/${idUsuario}`)
            .then(resposta => {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        // alert(JSON.stringify(resposta))
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção das publicações do usuário: ${error.message}`);
            });
    }

    function finalizarAguardar(resposta) {
        if (resposta) {
            div_erro.style.visibility = 'visible';
            div_erro.innerHTML = resposta;
        }
    }

    verificar_autenticacao();
</script>